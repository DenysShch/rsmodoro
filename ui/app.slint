export component AppWindow inherits Window {
    title: "rsmodoro";
    width: 300px;
    height: 150px;
    background: transparent;
    no-frame: true;
    always-on-top: true;
    default-font-family: "TX02 Nerd Font";

    // Theme properties (set from Rust config)
    in-out property <brush> theme-bg: #000000;
    in-out property <brush> theme-input-bg: #111111;
    in-out property <brush> theme-text: #cccccc;
    in-out property <brush> theme-text-dim: #777777;
    in-out property <brush> theme-icon: #888888;
    in-out property <brush> theme-accent: #4CAF50;
    in-out property <brush> theme-accent-rest: #2196F3;
    in-out property <bool> theme-transparent: false;

    // Window drag callback (handled in Rust)
    callback window-drag(float, float);

    // Background rectangle (workaround for no-frame window)
    Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: theme-transparent ? transparent : theme-bg;
        drag-area := TouchArea {
             moved => {
                 if (self.pressed) {
                     window-drag(
                         (self.mouse-x - self.pressed-x) / 1px,
                         (self.mouse-y - self.pressed-y) / 1px
                     );
                 }
             }
         }

    }

    // Timer properties
    in-out property <string> time: "25:00";
    in-out property <int> duration: 25;
    in-out property <int> rest-duration: 5;
    in-out property <float> progress: 1.0;
    in-out property <bool> running: false;
    in-out property <bool> finished: false;
    in-out property <bool> is-rest: false;

    // Tab state: 0 = Timer, 1 = Alarm
    in-out property <int> active-tab: 0;

    // Alarm properties
    in-out property <int> alarm-hours: 8;
    in-out property <int> alarm-minutes: 0;
    in-out property <bool> alarm-enabled: false;
    in-out property <bool> alarm-triggered: false;
    in-out property <string> alarm-remaining: "00:00:00";

    // Timer callbacks
    callback start();
    callback pause();
    callback reset();
    callback duration-changed(int, bool);  // (minutes, is_rest)

    // Alarm callbacks
    callback alarm-time-changed(int, int);  // (hours, minutes)
    callback alarm-start();
    callback alarm-reset();

    VerticalLayout {
        padding-top: 10px;
        padding-left: 20px;
        padding-right: 20px;
        padding-bottom: 0px;
        spacing: 10px;

        // Top bar with all controls: Play | Stop | Separator | Timer | Alarm
        HorizontalLayout {
            alignment: center;
            spacing: 8px;

            // Play/Pause toggle button
            Rectangle {
                width: 32px;
                height: 32px;
                background: transparent;
                border-radius: 16px;
                play-touch := TouchArea {
                    clicked => {
                        if (active-tab == 0) {
                            if (running) {
                                pause();
                            } else {
                                start();
                            }
                        } else {
                            if (!alarm-enabled) {
                                alarm-start();
                            }
                        }
                    }
                }

                // Play icon - shown when timer not running or alarm not enabled
                if (active-tab == 0 && !running) || (active-tab == 1 && !alarm-enabled): Text {
                    text: "\u{f040a}";  // MD play
                    color: theme-icon;
                    font-size: 18px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                // Pause icon - shown when timer running
                if active-tab == 0 && running: Text {
                    text: "\u{f03e4}";  // MD pause
                    color: theme-icon;
                    font-size: 18px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                // Pause icon - shown when alarm enabled
                if active-tab == 1 && alarm-enabled && !alarm-triggered: Text {
                    text: "\u{f03e4}";  // MD pause
                    color: theme-icon;
                    font-size: 18px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // Stop/Reset icon
            Rectangle {
                width: 32px;
                height: 32px;
                background: transparent;
                border-radius: 16px;
                stop-touch := TouchArea {
                    clicked => {
                        if (active-tab == 0) {
                            reset();
                        } else {
                            alarm-reset();
                        }
                    }
                }
                Text {
                    text: "\u{f04db}";  // MD stop
                    color: theme-icon;
                    font-size: 18px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // Separator pipe |
            Text {
                text: "|";
                color: theme-text-dim;
                font-size: 24px;
                vertical-alignment: center;
            }

            // Timer tab (clock icon)
            Rectangle {
                width: 32px;
                height: 32px;
                background: transparent;
                border-radius: 8px;

                timer-tab-touch := TouchArea {
                    clicked => { active-tab = 0; }
                }

                Text {
                    text: "\u{f13ab} ";  // MD timer-outline
                    color: active-tab == 0 ? theme-text : theme-text-dim;
                    font-size: 20px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            // Alarm tab (bell icon)
            Rectangle {
                width: 32px;
                height: 32px;
                background: transparent;
                border-radius: 8px;

                alarm-tab-touch := TouchArea {
                    clicked => { active-tab = 1; }
                }

                Text {
                    text: "\u{f116b} ";  // MD alarm
                    color: active-tab == 1 ? theme-text : theme-text-dim;
                    font-size: 20px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }

        // ============ Timer Tab Content ============
        if active-tab == 0: VerticalLayout {
            spacing: 10px;
            alignment: center;

            // Fixed height display area
            Rectangle {
                height: 60px;

                // Timer display - only when running
                if running: Text {
                    text: time;
                    font-size: 42px;
                    color: theme-text;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                // Finished display - when timer completed
                if !running && finished: Text {
                    text: "٩(◕‿◕｡)۶";
                    font-size: 42px;
                    color: theme-accent;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                // Duration inputs - only when not running and not finished
                if !running && !finished: VerticalLayout {
                    spacing: 4px;

                    // Work duration input
                    HorizontalLayout {
                        alignment: center;
                        spacing: 8px;

                        Text {
                            text: "Work:";
                            color: theme-text-dim;
                            font-size: 14px;
                            vertical-alignment: center;
                        }

                        Rectangle {
                            width: 50px;
                            height: 26px;
                            background: theme-input-bg;
                            border-radius: 4px;

                            work-input := TextInput {
                                text: duration;
                                width: 100%;
                                height: 100%;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                input-type: number;
                                color: theme-text;
                                edited => {
                                    duration-changed(max(1, min(120, self.text.to-float())), false);
                                }
                            }
                        }

                        Text {
                            text: "min";
                            color: theme-text-dim;
                            font-size: 14px;
                            vertical-alignment: center;
                        }
                    }

                    // Rest duration input
                    HorizontalLayout {
                        alignment: center;
                        spacing: 8px;

                        Text {
                            text: "Rest:";
                            color: theme-text-dim;
                            font-size: 14px;
                            vertical-alignment: center;
                        }

                        Rectangle {
                            width: 50px;
                            height: 26px;
                            background: theme-input-bg;
                            border-radius: 4px;

                            rest-input := TextInput {
                                text: rest-duration;
                                width: 100%;
                                height: 100%;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                                input-type: number;
                                color: theme-text;
                                edited => {
                                    duration-changed(max(1, min(30, self.text.to-float())), true);
                                }
                            }
                        }

                        Text {
                            text: "min";
                            color: theme-text-dim;
                            font-size: 14px;
                            vertical-alignment: center;
                        }
                    }
                }
            }

            // Spacer
            Rectangle {
                vertical-stretch: 1;
            }
        }

        // ============ Alarm Tab Content ============
        if active-tab == 1: VerticalLayout {
            spacing: 10px;
            alignment: center;

            // Fixed height display area (same as Timer tab)
            Rectangle {
                height: 60px;

                // Triggered state - show "Finished!"
                if alarm-triggered: Text {
                    text: "٩(◕‿◕｡)۶";
                    font-size: 42px;
                    color: theme-accent;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                // Enabled state - show remaining time countdown
                if alarm-enabled && !alarm-triggered: Text {
                    text: alarm-remaining;
                    font-size: 42px;
                    color: theme-text;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                // Idle state - show time picker
                if !alarm-enabled && !alarm-triggered: HorizontalLayout {
                    alignment: center;
                    spacing: 10px;

                    // Hours input
                    Rectangle {
                        width: 70px;
                        height: 50px;
                        background: theme-input-bg;
                        border-radius: 8px;

                        hours-input := TextInput {
                            text: alarm-hours < 10 ? "0\{alarm-hours}" : alarm-hours;
                            width: 100%;
                            height: 100%;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            input-type: number;
                            font-size: 28px;
                            color: theme-text;
                            edited => {
                                alarm-time-changed(max(0, min(23, self.text.to-float())), alarm-minutes);
                            }
                        }
                    }

                    // Colon separator
                    Text {
                        text: ":";
                        font-size: 36px;
                        color: theme-text-dim;
                        vertical-alignment: center;
                    }

                    // Minutes input
                    Rectangle {
                        width: 70px;
                        height: 50px;
                        background: theme-input-bg;
                        border-radius: 8px;

                        minutes-input := TextInput {
                            text: alarm-minutes < 10 ? "0\{alarm-minutes}" : alarm-minutes;
                            width: 100%;
                            height: 100%;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            input-type: number;
                            font-size: 28px;
                            color: theme-text;
                            edited => {
                                alarm-time-changed(alarm-hours, max(0, min(59, self.text.to-float())));
                            }
                        }
                    }
                }
            }

            // Spacer
            Rectangle {
                vertical-stretch: 1;
            }
        }
    }

    // Progress bar at bottom (only show on Timer tab)
    if active-tab == 0: Rectangle {
        x: 0;
        y: parent.height - 6px;
        width: parent.width * progress;
        height: 6px;
        background: is-rest ? theme-accent-rest : theme-accent;  // Blue for rest, green for work
    }
}
